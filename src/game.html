<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TicTacToe</title>
  <style>
    #backboard { position: absolute; width: 500px; height: 500px; background: #000000; }
    #vl1, #vl2, #hl1, #hl2 { position: absolute; width: 500px; height: 0px; border: 1px solid #FFFFFF; }
    #vl1 { margin-top: 250px; margin-left: -83.33px; transform: rotate(90deg); }
    #vl2 { margin-top: 250px; margin-left: 83.33px; transform: rotate(90deg); }
    #hl1 { margin-top: 166px; }
    #hl2 { margin-top: 334px; }
    .zone { position: absolute; width: 84px; height: 84px; /* border: 1px solid #882929; */ }
    .p0 { position: absolute; width: 84.85px; height: 84.85px; margin-top: 42px;  margin-left: 42px; }
    .p1 { position: absolute; width: 84.85px; height: 84.85px; margin-top: 42px;  margin-left: 208px; }
    .p2 { position: absolute; width: 84.85px; height: 84.85px; margin-top: 42px;  margin-left: 377px; }
    .p3 { position: absolute; width: 84.85px; height: 84.85px; margin-top: 210px; margin-left: 42px; }
    .p4 { position: absolute; width: 84.85px; height: 84.85px; margin-top: 210px; margin-left: 208px; }
    .p5 { position: absolute; width: 84.85px; height: 84.85px; margin-top: 210px; margin-left: 377px; }
    .p6 { position: absolute; width: 84.85px; height: 84.85px; margin-top: 375px; margin-left: 42px; }
    .p7 { position: absolute; width: 84.85px; height: 84.85px; margin-top: 375px; margin-left: 208px; }
    .p8 { position: absolute; width: 84.85px; height: 84.85px; margin-top: 375px; margin-left: 377px; }
    .x, .o { visibility: hidden; }
  </style>
</head>
<body>
  <div id="backboard">
    <div id="hl1"></div><div id="hl2"></div>
    <div id="vl1"></div><div id="vl2"></div>

    <!-- X SVGs -->
    <svg id="x0" class="p0 x" width="87" height="86" viewBox="0 0 87 86" fill="none" xmlns="http://www.w3.org/2000/svg">
      <line x1="1.35355" y1="0.646447" x2="86.2064" y2="85.4993" stroke="white" />
      <line x1="0.646447" y1="85.4993" x2="85.4993" y2="0.646448" stroke="white" />
    </svg>
    <svg id="x1" class="p1 x" width="87" height="86" viewBox="0 0 87 86" fill="none" xmlns="http://www.w3.org/2000/svg">
      <line x1="1.35355" y1="0.646447" x2="86.2064" y2="85.4993" stroke="white" />
      <line x1="0.646447" y1="85.4993" x2="85.4993" y2="0.646448" stroke="white" />
    </svg>
    <svg id="x2" class="p2 x" width="87" height="86" viewBox="0 0 87 86" fill="none" xmlns="http://www.w3.org/2000/svg">
      <line x1="1.35355" y1="0.646447" x2="86.2064" y2="85.4993" stroke="white" />
      <line x1="0.646447" y1="85.4993" x2="85.4993" y2="0.646448" stroke="white" />
    </svg>
    <svg id="x3" class="p3 x" width="87" height="86" viewBox="0 0 87 86" fill="none" xmlns="http://www.w3.org/2000/svg">
      <line x1="1.35355" y1="0.646447" x2="86.2064" y2="85.4993" stroke="white" />
      <line x1="0.646447" y1="85.4993" x2="85.4993" y2="0.646448" stroke="white" />
    </svg>
    <svg id="x4" class="p4 x" width="87" height="86" viewBox="0 0 87 86" fill="none" xmlns="http://www.w3.org/2000/svg">
      <line x1="1.35355" y1="0.646447" x2="86.2064" y2="85.4993" stroke="white" />
      <line x1="0.646447" y1="85.4993" x2="85.4993" y2="0.646448" stroke="white" />
    </svg>
    <svg id="x5" class="p5 x" width="87" height="86" viewBox="0 0 87 86" fill="none" xmlns="http://www.w3.org/2000/svg">
      <line x1="1.35355" y1="0.646447" x2="86.2064" y2="85.4993" stroke="white" />
      <line x1="0.646447" y1="85.4993" x2="85.4993" y2="0.646448" stroke="white" />
    </svg>
    <svg id="x6" class="p6 x" width="87" height="86" viewBox="0 0 87 86" fill="none" xmlns="http://www.w3.org/2000/svg">
      <line x1="1.35355" y1="0.646447" x2="86.2064" y2="85.4993" stroke="white" />
      <line x1="0.646447" y1="85.4993" x2="85.4993" y2="0.646448" stroke="white" />
    </svg>
    <svg id="x7" class="p7 x" width="87" height="86" viewBox="0 0 87 86" fill="none" xmlns="http://www.w3.org/2000/svg">
      <line x1="1.35355" y1="0.646447" x2="86.2064" y2="85.4993" stroke="white" />
      <line x1="0.646447" y1="85.4993" x2="85.4993" y2="0.646448" stroke="white" />
    </svg>
    <svg id="x8" class="p8 x" width="87" height="86" viewBox="0 0 87 86" fill="none" xmlns="http://www.w3.org/2000/svg">
      <line x1="1.35355" y1="0.646447" x2="86.2064" y2="85.4993" stroke="white" />
      <line x1="0.646447" y1="85.4993" x2="85.4993" y2="0.646448" stroke="white" />
    </svg>

    <!-- O SVGs -->
    <svg id="o0" class="p0 o" width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="55" cy="55" r="54.5" stroke="white" /></svg>
    <svg id="o1" class="p1 o" width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="55" cy="55" r="54.5" stroke="white" /></svg>
    <svg id="o2" class="p2 o" width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="55" cy="55" r="54.5" stroke="white" /></svg>
    <svg id="o3" class="p3 o" width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="55" cy="55" r="54.5" stroke="white" /></svg>
    <svg id="o4" class="p4 o" width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="55" cy="55" r="54.5" stroke="white" /></svg>
    <svg id="o5" class="p5 o" width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="55" cy="55" r="54.5" stroke="white" /></svg>
    <svg id="o6" class="p6 o" width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="55" cy="55" r="54.5" stroke="white" /></svg>
    <svg id="o7" class="p7 o" width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="55" cy="55" r="54.5" stroke="white" /></svg>
    <svg id="o8" class="p8 o" width="110" height="110" viewBox="0 0 110 110" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="55" cy="55" r="54.5" stroke="white" /></svg>

    <!-- Click zones -->
    <div id="z0" class="p0 zone"></div><div id="z1" class="p1 zone"></div><div id="z2" class="p2 zone"></div>
    <div id="z3" class="p3 zone"></div><div id="z4" class="p4 zone"></div><div id="z5" class="p5 zone"></div>
    <div id="z6" class="p6 zone"></div><div id="z7" class="p7 zone"></div><div id="z8" class="p8 zone"></div>
  </div>

  <script>
    const vscode = acquireVsCodeApi();

    // --- Game state ---
    // values: X = 1, O = 2, empty = 0
    let gameArr = [0,0,0,0,0,0,0,0,0];
    let moves = 0;
    let blocked = 0;
    let difficulty = 'Hard';  // can be overridden by extension
    let opponent = 'Computer';

    // --- Helpers to show/hide marks ---
    function showX(i) { document.getElementById(`x${i}`).style.visibility = 'visible'; }
    function showO(i) { document.getElementById(`o${i}`).style.visibility = 'visible'; }
    function hideAll() {
      for (let i = 0; i < 9; i++) {
        document.getElementById(`x${i}`).style.visibility = 'hidden';
        document.getElementById(`o${i}`).style.visibility = 'hidden';
      }
    }

    function restart() {
      blocked = 0;
      gameArr = [0,0,0,0,0,0,0,0,0];
      moves = 0; // fixed: do NOT redeclare with var
      hideAll();
      vscode.postMessage({ command: 'info', text: `Your move again X` });
    }

    function reset(winner) {
      const winPerson = winner !== 2 ? (winner === 1 ? 'You win' : 'No one wins') : 'Bot wins';
      vscode.postMessage({ command: 'info', text: `${winPerson} this game` });
      blocked = 1;
      vscode.postMessage({ command: 'play-again', text: 'Play again?' });
    }

    function checkWin() {
      // rows
      for (let i = 0; i <= 6; i += 3) {
        if (gameArr[i] && gameArr[i] === gameArr[i+1] && gameArr[i+1] === gameArr[i+2]) {
          reset(gameArr[i]); return 1;
        }
      }
      // cols
      for (let i = 0; i <= 2; i++) {
        if (gameArr[i] && gameArr[i] === gameArr[i+3] && gameArr[i+3] === gameArr[i+6]) {
          reset(gameArr[i]); return 1;
        }
      }
      // diagonals
      if (gameArr[0] && gameArr[0] === gameArr[4] && gameArr[4] === gameArr[8]) { reset(gameArr[0]); return 1; }
      if (gameArr[2] && gameArr[2] === gameArr[4] && gameArr[4] === gameArr[6]) { reset(gameArr[2]); return 1; }
      return 0;
    }

    // ---------- AI (minimax + alpha-beta, deterministic) ----------
    const LINES = [
      [0,1,2],[3,4,5],[6,7,8],
      [0,3,6],[1,4,7],[2,5,8],
      [0,4,8],[2,4,6]
    ];

    function evalWinner(b) {
      for (const [a,c,d] of LINES) {
        if (b[a] && b[a] === b[c] && b[a] === b[d]) return b[a]; // 1 or 2
      }
      return 0;
    }
    function isDrawBoard(b) { return !evalWinner(b) && b.every(v => v !== 0); }

    // Deterministic ordering: center → corners → edges
    function orderedMoves(b) { return [4,0,2,6,8,1,3,5,7].filter(i => b[i] === 0); }

    function getBestMove(b, ai = 2, human = 1, diff = 'Hard') {
      const depthCap = diff === 'Easy' ? 1 : diff === 'Medium' ? 3 : 9;

      function score(board) {
        const w = evalWinner(board);
        if (w === ai) return 10;
        if (w === human) return -10;
        return 0;
      }

      function minimax(board, player, depth, alpha, beta) {
        const s = score(board);
        if (s !== 0 || isDrawBoard(board) || depth >= depthCap) return s;

        if (player === ai) {
          let best = -Infinity;
          for (const i of orderedMoves(board)) {
            board[i] = ai;
            best = Math.max(best, minimax(board, human, depth + 1, alpha, beta));
            board[i] = 0;
            alpha = Math.max(alpha, best);
            if (beta <= alpha) break;
          }
          return best;
        } else {
          let best = Infinity;
          for (const i of orderedMoves(board)) {
            board[i] = human;
            best = Math.min(best, minimax(board, ai, depth + 1, alpha, beta));
            board[i] = 0;
            beta = Math.min(beta, best);
            if (beta <= alpha) break;
          }
          return best;
        }
      }

      let bestScore = -Infinity;
      let bestMove = null;
      for (const i of orderedMoves(b)) {
        b[i] = ai;
        const val = minimax(b, human, 0, -Infinity, Infinity);
        b[i] = 0;
        if (val > bestScore) { bestScore = val; bestMove = i; }
      }
      return bestMove;
    }
    // --------------------------------------------------------------

    function userMove(event) {
      const id = event.target.id;
      const box = id[1];
      if (blocked) return;

      const idx = parseInt(box, 10);
      if (gameArr[idx] === 0) {
        // Human play (X)
        showX(idx);
        gameArr[idx] = 1;
        moves++;

        if (checkWin()) return;

        if (moves === 9) {
          reset(0); // draw
          return;
        }

        // AI turn (if playing against computer)
        if (opponent === 'Computer') {
          setTimeout(() => {
            const move = getBestMove(gameArr.slice(), 2, 1, difficulty);
            if (move != null) {
              moves++;
              gameArr[move] = 2;
              showO(move);
              checkWin();
            }
          }, 60); // tiny delay for UX
        }
      }
    }

    // Attach click handlers once DOM is ready
    for (let i = 0; i < 9; i++) {
      document.getElementById(`z${i}`).addEventListener('click', userMove);
    }

    // Messaging with extension
    window.addEventListener('message', (event) => {
      const message = event.data;
      switch (message.command) {
        case 'restart':
          restart();
          break;
        case 'init':
          opponent = message.opponent || 'Computer';
          difficulty = message.difficulty || 'Hard';
          restart();
          break;
      }
    });

    // Tell the extension we're ready to receive init
    window.addEventListener('DOMContentLoaded', () => {
      vscode.postMessage({ command: 'ready' });
    });
  </script>
</body>
</html>
